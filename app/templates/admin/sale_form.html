{% extends "admin/base_admin.html" %}

{% block title %}New Sale - {{ shop_settings.shop_name }}{% endblock %}

{% block admin_content %}
<div class="page-header">
    <h4><i class="bi bi-cart-plus"></i> Record New Sale</h4>
    <p class="text-muted mb-0">Process a new drug sale</p>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <form method="POST" id="saleForm">
                    {{ form.hidden_tag() }}
                    
                    <div class="mb-3">
                        <label class="form-label">Select Drug *</label>
                        {{ form.drug_id(class="form-select", id="drugSelect") }}
                        {% for error in form.drug_id.errors %}
                            <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Quantity *</label>
                            {{ form.quantity(class="form-control", id="quantity", min="1") }}
                            {% for error in form.quantity.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Payment Method</label>
                            {{ form.payment_method(class="form-select") }}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Customer Name</label>
                            {{ form.customer_name(class="form-control", placeholder="Optional") }}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Customer Phone</label>
                            {{ form.customer_phone(class="form-control", placeholder="Optional") }}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        {{ form.notes(class="form-control", rows="2", placeholder="Any additional notes...") }}
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-check-circle"></i> Complete Sale
                        </button>
                        <a href="{{ url_for('admin.sales') }}" class="btn btn-secondary btn-lg">
                            <i class="bi bi-x-circle"></i> Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card bg-light">
            <div class="card-body">
                <h5><i class="bi bi-receipt"></i> Sale Summary</h5>
                <hr>
                <div class="d-flex justify-content-between mb-2">
                    <span>Unit Price:</span>
                    <strong id="unitPrice">UGX 0</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Quantity:</span>
                    <strong id="displayQty">0</strong>
                </div>
                <hr>
                <div class="d-flex justify-content-between">
                    <span class="h5">Total:</span>
                    <strong class="h5 text-success" id="totalAmount">UGX 0</strong>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const drugSelect = document.getElementById('drugSelect');
    const quantityInput = document.getElementById('quantity');
    const unitPriceEl = document.getElementById('unitPrice');
    const displayQtyEl = document.getElementById('displayQty');
    const totalAmountEl = document.getElementById('totalAmount');
    
    function updateTotal() {
        const selectedOption = drugSelect.options[drugSelect.selectedIndex];
        const text = selectedOption.text;
        const priceMatch = text.match(/UGX ([\d,]+)/);
        
        let unitPrice = 0;
        if (priceMatch) {
            unitPrice = parseFloat(priceMatch[1].replace(/,/g, ''));
        }
        
        const quantity = parseInt(quantityInput.value) || 0;
        const total = unitPrice * quantity;
        
        unitPriceEl.textContent = 'UGX ' + unitPrice.toLocaleString();
        displayQtyEl.textContent = quantity;
        totalAmountEl.textContent = 'UGX ' + total.toLocaleString();
    }
    
    drugSelect.addEventListener('change', updateTotal);
    quantityInput.addEventListener('input', updateTotal);
});
</script>
{% endblock %}
